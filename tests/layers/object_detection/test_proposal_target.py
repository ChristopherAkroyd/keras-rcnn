# import keras.backend
# import keras.utils
# import numpy
#
# import keras_rcnn.layers
# import keras_rcnn.layers.object_detection._proposal_target as proposal_target
#
#
# class TestProposalTarget:
#     def test_call(self):
#         proposal_target = keras_rcnn.layers.ProposalTarget()
#
#         proposals = numpy.random.random((1, 300, 4))
#         proposals = keras.backend.variable(proposals)
#
#         bounding_boxes = numpy.random.choice(range(0, 224), (1, 10, 4))
#         bounding_boxes = keras.backend.variable(bounding_boxes)
#
#         labels = numpy.random.choice(range(0, 2), (1, 10))
#         labels = keras.utils.to_categorical(labels)
#         labels = keras.backend.variable(labels)
#         labels = keras.backend.expand_dims(labels, 0)
#
#         proposal_target.call([proposals, labels, bounding_boxes])
#
#     def test_build(self):
#         pass
#
#     def test_compute_output_shape(self):
#         pass
#
#     def test_compute_mask(self):
#         pass
#
#     def test_set_label_background(self):
#         proposal_target = keras_rcnn.layers.ProposalTarget(
#                 fg_fraction=0.5,
#                 fg_thresh=0.5,
#                 bg_thresh_hi=0.5,
#                 bg_thresh_lo=0.1,
#                 batchsize=256,
#                 num_images=1
#         )
#         all_rois = numpy.array([
#             [  50.71208954,   70.44628143,   90.61702728,   99.66291046],
#             [  55.45672607,   67.94913483,   86.19535828,   98.13130951],
#             [ 107.53626251,    1.19126511,  127.        ,   40.5984726 ],
#             [  50.50813293,   79.33403778,   87.0002594 ,  117.19319916],
#             [ 101.94552612,    0.        ,  125.88674927,   37.46565247],
#             [   0.        ,    0.        ,  127.        ,   88.        ],
#             [   0.        ,   24.        ,  127.        ,  120.        ],
#             [  98.8294754 ,   21.01197243,  127.        ,   59.66217804],
#             [  94.43806458,    3.28402901,  127.        ,   44.11544037],
#             [   0.        ,   56.        ,  127.        ,  127.        ],
#             [   0.        ,    0.        ,  127.        ,   56.        ],
#             [  28.        ,   40.        ,  127.        ,  127.        ],
#             [  91.25584412,    0.        ,  116.2077179 ,   32.36594391],
#             [   0.        ,   40.        ,  100.        ,  127.        ],
#             [   0.        ,    8.        ,  100.        ,  104.        ],
#             [  16.        ,    0.        ,  127.        ,  127.        ],
#             [  28.        ,    8.        ,  127.        ,  104.        ],
#             [   0.        ,    0.        ,  100.        ,   72.        ],
#             [  50.74036407,   94.12261963,   86.55892181,  127.        ],
#             [   0.        ,   72.        ,  100.        ,  127.        ],
#             [ 103.20545959,   86.37854004,  127.        ,  127.        ],
#             [  40.        ,    0.        ,  127.        ,   88.        ],
#             [  56.        ,    0.        ,  127.        ,   72.        ],
#             [  28.        ,   72.        ,  127.        ,  127.        ],
#             [  56.        ,   56.        ,  127.        ,  127.        ],
#             [  76.        ,   32.        ,  127.        ,  127.        ],
#             [   0.        ,   56.        ,   72.        ,  127.        ],
#             [   0.        ,    0.        ,   72.        ,   88.        ],
#             [  76.        ,    0.        ,  127.        ,   96.        ],
#             [   0.        ,   32.        ,   52.        ,  127.        ],
#             [  56.        ,    0.        ,  127.        ,  120.        ],
#             [   0.        ,    0.        ,   52.        ,   96.        ],
#             [   0.        ,   24.        ,   72.        ,  127.        ],
#             [  97.16458893,   98.0249939 ,  127.        ,  127.        ],
#             [ 108.26307678,   18.04890442,  127.        ,   51.71542358],
#             [  94.32286072,    0.        ,  127.        ,   22.97975922],
#             [   7.79359531,    0.        ,   36.87153625,   17.60238075],
#             [   0.        ,    0.        ,   84.        ,  127.        ],
#             [   0.        ,  106.34275055,   49.92878723,  127.        ],
#             [   0.        ,   99.0591507 ,   35.27072525,  127.        ],
#             [  14.40047836,  102.94164276,   66.9264679 ,  127.        ],
#             [  19.59460831,   94.52481079,   58.59706497,  127.        ],
#             [   0.        ,    0.        ,   41.47511673,   30.94105721],
#             [   0.        ,   91.5510025 ,   23.51871109,  127.        ],
#             [  98.41709137,   32.52594757,  127.        ,   70.71497345],
#             [  83.86433411,    0.        ,  126.68435669,   17.05216599],
#             [   4.25742149,  103.77056885,   40.9630661 ,  127.        ],
#             [  92.50645447,   18.36931801,  127.        ,   74.69480896],
#             [   0.        ,    0.        ,   23.31191254,   45.55099106],
#             [   0.        ,   85.20574951,   18.08465958,  127.        ],
#             [  34.76586914,   91.0597229 ,   70.21446991,  127.        ],
#             [  31.57422256,   98.00201416,   82.33876038,  127.        ],
#             [   0.        ,    1.70124626,   18.00316238,   58.02664948],
#             [  47.77222824,  100.66429138,   97.60723877,  127.        ],
#             [  49.00650024,    0.        ,   87.90568542,   18.85537338],
#             [   2.66373634,    0.        ,   31.10864067,   32.25665665],
#             [   7.98152542,   98.91853333,   75.25076294,  127.        ],
#             [  96.10111237,   82.96366882,  127.        ,  124.20684814],
#             [ 100.59230042,   51.73586655,  127.        ,   90.42410278],
#             [  62.81672668,  105.77951813,  100.79664612,  127.        ],
#             [  39.32888031,   78.95227814,   70.62407684,  127.        ],
#             [  83.66664124,    0.        ,  123.00033569,   42.14031601],
#             [  35.41271973,   96.42881775,  102.99723816,  127.        ],
#             [  86.72212219,  104.05187988,  121.45080566,  127.        ],
#             [  34.50315857,    0.        ,   72.09360504,   21.45676422],
#             [  49.67893219,   85.49975586,   94.36956024,  122.12127686],
#             [  16.8948822 ,    0.        ,   57.12744904,   23.87054443],
#             [   0.        ,    0.        ,   49.20021057,   22.89399529],
#             [  92.50393677,   31.71694946,  116.82061768,   75.54193115],
#             [ 101.27336884,   68.32675171,  127.        ,  107.76806641],
#             [ 103.63972473,   64.72322845,  127.        ,  121.69217682],
#             [   0.        ,    2.98220253,   31.56446838,   48.02368927],
#             [  98.78588104,   41.22549438,  127.        ,   98.6265564 ],
#             [  43.14202118,   83.98725128,   81.71795654,  126.31203461],
#             [  77.02322388,   50.71312714,  116.16117859,   85.06006622],
#             [   0.        ,   81.65694427,   32.60420227,  123.96698761],
#             [ 103.44710541,   14.21045494,  127.        ,   40.28822327],
#             [  69.66470337,    0.        ,  110.63270569,   21.06321716],
#             [   0.        ,    3.10115814,   19.54813766,   39.10132217],
#             [   0.        ,   18.57296562,   24.90319443,   61.45012665],
#             [  80.68254089,  100.47480774,  127.        ,  127.        ],
#             [  22.4812355 ,    0.        ,   51.37631607,   19.1945343 ],
#             [  57.52688599,   90.20191956,   91.05926514,  127.        ],
#             [  95.99333191,   28.11805344,  127.        ,   54.7819252 ],
#             [  66.12437439,  109.61106873,  112.16593933,  127.        ],
#             [   0.        ,   34.92645645,   23.40029144,   76.49604797],
#             [   0.        ,   24.81159973,   30.09602737,   64.4962616 ],
#             [  71.15076447,    0.        ,   98.23110199,   24.22634506],
#             [  57.86538696,   69.31452942,  100.78405762,  105.31706238],
#             [  56.96481705,    0.        ,   84.40791321,   16.61228561],
#             [  52.54270172,   71.56542969,   84.0104599 ,  106.01870728],
#             [  59.92431641,   51.18797302,   93.5614624 ,   96.81411743],
#             [  46.53039551,   60.00773621,   76.70639038,  105.10090637],
#             [   0.        ,   51.24388123,   20.01187706,   91.44229126],
#             [   0.        ,   40.91738892,   29.76662064,   79.57460785],
#             [   0.        ,   66.71936798,   23.33432007,  107.1989212 ],
#             [  52.53593826,   56.81362534,   87.6943512 ,   80.978302  ],
#             [  23.93180656,    0.        ,   65.24099731,   21.62162399],
#             [  52.88409424,   62.21540833,   86.62045288,   94.69174194],
#             [  62.93517303,    0.        ,   97.4132309 ,   21.67671776],
#             [  80.08380127,   71.31486511,  112.64286804,  106.20582581],
#             [   0.        ,   75.59233093,   29.57452393,  115.32017517],
#             [   0.        ,   94.73368835,   29.12003326,  122.7570343 ],
#             [  56.74416351,   62.87185669,   83.51163483,  102.64590454],
#             [  56.4704361 ,   67.04311371,   88.26943207,  107.08548737],
#             [  61.38975525,   99.27015686,  116.5189209 ,  127.        ],
#             [  74.17579651,    0.        ,  111.2371521 ,   29.42921066],
#             [  89.39240265,   47.07178497,  126.46971893,   87.31560516],
#             [  69.44123077,   47.38218307,  108.40250397,   79.6802063 ],
#             [   0.        ,   57.49836731,   29.66657829,   95.89842224],
#             [  78.95790863,   37.56030273,  115.78124237,   78.61038971],
#             [   1.05501747,   49.41056061,   23.29784775,   78.91101837],
#             [  85.10821533,   96.18637848,  113.51568604,  127.        ],
#             [   0.        ,    4.97987747,   42.77118683,   39.50862122],
#             [  20.71508408,   86.12203979,   66.83483887,  127.        ],
#             [  92.37216949,    5.15529823,  120.51592255,   36.1371994 ],
#             [  18.54267502,    7.85336876,   47.64195633,   40.28590393],
#             [  70.94502258,   10.51726341,   96.90571594,   49.78765106],
#             [  78.40616608,   34.65525818,  110.38196564,   65.63249969],
#             [  62.15895844,   59.15465546,  105.94535065,   89.95876312],
#             [   1.27451801,   69.83500671,   25.79981232,   97.2482605 ],
#             [  62.73934174,   83.32158661,  101.73313141,  120.8647995 ],
#             [  45.75923157,   59.99327469,   71.63579559,   98.12197876],
#             [  56.19100189,   14.82108879,   84.26691437,   44.36116791],
#             [  65.84653473,   42.47505951,   97.59632111,   82.20253754],
#             [  69.37020874,   94.50706482,  108.35041809,  127.        ],
#             [  37.10490417,    9.61324596,   64.72504425,   38.63171387],
#             [  85.3844986 ,   66.10962677,  110.31502533,  107.09311676],
#             [  37.36283112,   60.59078217,   61.06542206,   91.03170013],
#             [  67.89260864,   71.75512695,  106.5725708 ,  102.57484436],
#             [  77.99923706,   16.48104858,  107.95568848,   48.56900024],
#             [  89.20878601,   71.41056824,  125.7568512 ,  107.29753113],
#             [   5.91212463,   32.58755112,   41.92187881,   62.24328232],
#             [  52.27661133,   39.26787949,   81.46669006,   69.80540466],
#             [  47.65753937,   40.49248505,   76.20034027,   76.36449432],
#             [  57.34262848,    7.1027317 ,   82.6523056 ,   36.4445343 ],
#             [  18.88934326,   92.23389435,   47.76045227,  124.64731598],
#             [   9.30751991,   49.58087158,   42.02339172,   77.00914764],
#             [  45.11285782,   61.83740234,   75.83686829,   87.559021  ],
#             [  15.24866962,   45.1537323 ,   40.4258461 ,   72.44976044],
#             [  26.69694901,   13.21245193,   60.47519302,   42.36695862],
#             [   3.4413681 ,   88.63192749,   40.75950241,  116.03289795],
#             [  33.86211777,   72.85886383,   64.36898804,  111.14054108],
#             [  27.03687096,   89.1621933 ,   60.37636566,  116.18755341],
#             [  32.48144913,   47.85022736,   59.34322739,   74.05560303],
#             [  15.24499512,   57.00760651,   38.60559464,   84.32082367],
#             [   9.1018734 ,   68.70444489,   41.70313263,   95.08370209],
#             [  29.1010685 ,   40.56064987,   54.72600555,   74.27661133],
#             [  63.39616394,   20.40607834,   91.86817932,   48.19306564],
#             [  59.84752655,   49.76169586,   92.02407074,   74.77848816],
#             [  22.08538437,   24.85385132,   47.61610031,   57.60162354],
#             [  46.91257477,   17.56220245,   76.49073029,   44.3457756 ],
#             [  31.83808899,   58.19957733,   59.74316406,   81.0170517 ],
#             [  32.10147095,   74.45246124,   59.8211441 ,   97.25855255],
#             [  56.94638062,   24.92946815,   84.93023682,   58.81396484],
#             [  17.57852745,   71.32565308,   40.61666107,  100.14833069],
#             [  44.46640396,   25.70672989,   69.00811768,   59.31702042],
#             [  31.93849182,   42.83921432,   60.13134766,   66.11750793],
#             [  47.41349792,   45.91717911,   75.39443207,   69.51273346]])
#         all_rois = keras.backend.variable(all_rois, 'float32')
#         gt_boxes = numpy.array([[ 105.,    7.,  127.,   44.],
#                                 [  51.,   78.,   92.,   98.]])
#         gt_boxes = keras.backend.variable(gt_boxes, 'float32')
#         labels = numpy.array([1] * 39)
#         labels = keras.backend.variable(labels)
#
#         overlaps = keras_rcnn.backend.overlap(all_rois, gt_boxes)
#         max_overlaps = keras.backend.max(overlaps, axis=1)
#         proposal_target.get_fg_bg_rois(max_overlaps)
#
#         result = proposal_target.set_label_background(labels)
#         result = keras.backend.eval(result)
#         expected = numpy.concatenate([numpy.array([1] * 8), numpy.array([0] * 31)])
#
#         numpy.testing.assert_array_almost_equal(result, expected)
#
#     def test_get_bbox_targets(self):
#         pass
#
#     def test_get_fg_bg_rois(self):
#         pass
#
#     def test_sample_indices(self):
#         pass
#
#     def test_sample_rois(self):
#         proposal_target = keras_rcnn.layers.ProposalTarget(
#                 fg_fraction=0.5,
#                 fg_thresh=0.5,
#                 bg_thresh_hi=0.5,
#                 bg_thresh_lo=0.1,
#                 batchsize=256,
#                 num_images=1
#         )
#         all_rois = numpy.array([
#             [  50.71208954,   70.44628143,   90.61702728,   99.66291046],
#             [  55.45672607,   67.94913483,   86.19535828,   98.13130951],
#             [ 107.53626251,    1.19126511,  127.        ,   40.5984726 ],
#             [  50.50813293,   79.33403778,   87.0002594 ,  117.19319916],
#             [ 101.94552612,    0.        ,  125.88674927,   37.46565247],
#             [   0.        ,    0.        ,  127.        ,   88.        ],
#             [   0.        ,   24.        ,  127.        ,  120.        ],
#             [  98.8294754 ,   21.01197243,  127.        ,   59.66217804],
#             [  94.43806458,    3.28402901,  127.        ,   44.11544037],
#             [   0.        ,   56.        ,  127.        ,  127.        ],
#             [   0.        ,    0.        ,  127.        ,   56.        ],
#             [  28.        ,   40.        ,  127.        ,  127.        ],
#             [  91.25584412,    0.        ,  116.2077179 ,   32.36594391],
#             [   0.        ,   40.        ,  100.        ,  127.        ],
#             [   0.        ,    8.        ,  100.        ,  104.        ],
#             [  16.        ,    0.        ,  127.        ,  127.        ],
#             [  28.        ,    8.        ,  127.        ,  104.        ],
#             [   0.        ,    0.        ,  100.        ,   72.        ],
#             [  50.74036407,   94.12261963,   86.55892181,  127.        ],
#             [   0.        ,   72.        ,  100.        ,  127.        ],
#             [ 103.20545959,   86.37854004,  127.        ,  127.        ],
#             [  40.        ,    0.        ,  127.        ,   88.        ],
#             [  56.        ,    0.        ,  127.        ,   72.        ],
#             [  28.        ,   72.        ,  127.        ,  127.        ],
#             [  56.        ,   56.        ,  127.        ,  127.        ],
#             [  76.        ,   32.        ,  127.        ,  127.        ],
#             [   0.        ,   56.        ,   72.        ,  127.        ],
#             [   0.        ,    0.        ,   72.        ,   88.        ],
#             [  76.        ,    0.        ,  127.        ,   96.        ],
#             [   0.        ,   32.        ,   52.        ,  127.        ],
#             [  56.        ,    0.        ,  127.        ,  120.        ],
#             [   0.        ,    0.        ,   52.        ,   96.        ],
#             [   0.        ,   24.        ,   72.        ,  127.        ],
#             [  97.16458893,   98.0249939 ,  127.        ,  127.        ],
#             [ 108.26307678,   18.04890442,  127.        ,   51.71542358],
#             [  94.32286072,    0.        ,  127.        ,   22.97975922],
#             [   7.79359531,    0.        ,   36.87153625,   17.60238075],
#             [   0.        ,    0.        ,   84.        ,  127.        ],
#             [   0.        ,  106.34275055,   49.92878723,  127.        ],
#             [   0.        ,   99.0591507 ,   35.27072525,  127.        ],
#             [  14.40047836,  102.94164276,   66.9264679 ,  127.        ],
#             [  19.59460831,   94.52481079,   58.59706497,  127.        ],
#             [   0.        ,    0.        ,   41.47511673,   30.94105721],
#             [   0.        ,   91.5510025 ,   23.51871109,  127.        ],
#             [  98.41709137,   32.52594757,  127.        ,   70.71497345],
#             [  83.86433411,    0.        ,  126.68435669,   17.05216599],
#             [   4.25742149,  103.77056885,   40.9630661 ,  127.        ],
#             [  92.50645447,   18.36931801,  127.        ,   74.69480896],
#             [   0.        ,    0.        ,   23.31191254,   45.55099106],
#             [   0.        ,   85.20574951,   18.08465958,  127.        ],
#             [  34.76586914,   91.0597229 ,   70.21446991,  127.        ],
#             [  31.57422256,   98.00201416,   82.33876038,  127.        ],
#             [   0.        ,    1.70124626,   18.00316238,   58.02664948],
#             [  47.77222824,  100.66429138,   97.60723877,  127.        ],
#             [  49.00650024,    0.        ,   87.90568542,   18.85537338],
#             [   2.66373634,    0.        ,   31.10864067,   32.25665665],
#             [   7.98152542,   98.91853333,   75.25076294,  127.        ],
#             [  96.10111237,   82.96366882,  127.        ,  124.20684814],
#             [ 100.59230042,   51.73586655,  127.        ,   90.42410278],
#             [  62.81672668,  105.77951813,  100.79664612,  127.        ],
#             [  39.32888031,   78.95227814,   70.62407684,  127.        ],
#             [  83.66664124,    0.        ,  123.00033569,   42.14031601],
#             [  35.41271973,   96.42881775,  102.99723816,  127.        ],
#             [  86.72212219,  104.05187988,  121.45080566,  127.        ],
#             [  34.50315857,    0.        ,   72.09360504,   21.45676422],
#             [  49.67893219,   85.49975586,   94.36956024,  122.12127686],
#             [  16.8948822 ,    0.        ,   57.12744904,   23.87054443],
#             [   0.        ,    0.        ,   49.20021057,   22.89399529],
#             [  92.50393677,   31.71694946,  116.82061768,   75.54193115],
#             [ 101.27336884,   68.32675171,  127.        ,  107.76806641],
#             [ 103.63972473,   64.72322845,  127.        ,  121.69217682],
#             [   0.        ,    2.98220253,   31.56446838,   48.02368927],
#             [  98.78588104,   41.22549438,  127.        ,   98.6265564 ],
#             [  43.14202118,   83.98725128,   81.71795654,  126.31203461],
#             [  77.02322388,   50.71312714,  116.16117859,   85.06006622],
#             [   0.        ,   81.65694427,   32.60420227,  123.96698761],
#             [ 103.44710541,   14.21045494,  127.        ,   40.28822327],
#             [  69.66470337,    0.        ,  110.63270569,   21.06321716],
#             [   0.        ,    3.10115814,   19.54813766,   39.10132217],
#             [   0.        ,   18.57296562,   24.90319443,   61.45012665],
#             [  80.68254089,  100.47480774,  127.        ,  127.        ],
#             [  22.4812355 ,    0.        ,   51.37631607,   19.1945343 ],
#             [  57.52688599,   90.20191956,   91.05926514,  127.        ],
#             [  95.99333191,   28.11805344,  127.        ,   54.7819252 ],
#             [  66.12437439,  109.61106873,  112.16593933,  127.        ],
#             [   0.        ,   34.92645645,   23.40029144,   76.49604797],
#             [   0.        ,   24.81159973,   30.09602737,   64.4962616 ],
#             [  71.15076447,    0.        ,   98.23110199,   24.22634506],
#             [  57.86538696,   69.31452942,  100.78405762,  105.31706238],
#             [  56.96481705,    0.        ,   84.40791321,   16.61228561],
#             [  52.54270172,   71.56542969,   84.0104599 ,  106.01870728],
#             [  59.92431641,   51.18797302,   93.5614624 ,   96.81411743],
#             [  46.53039551,   60.00773621,   76.70639038,  105.10090637],
#             [   0.        ,   51.24388123,   20.01187706,   91.44229126],
#             [   0.        ,   40.91738892,   29.76662064,   79.57460785],
#             [   0.        ,   66.71936798,   23.33432007,  107.1989212 ],
#             [  52.53593826,   56.81362534,   87.6943512 ,   80.978302  ],
#             [  23.93180656,    0.        ,   65.24099731,   21.62162399],
#             [  52.88409424,   62.21540833,   86.62045288,   94.69174194],
#             [  62.93517303,    0.        ,   97.4132309 ,   21.67671776],
#             [  80.08380127,   71.31486511,  112.64286804,  106.20582581],
#             [   0.        ,   75.59233093,   29.57452393,  115.32017517],
#             [   0.        ,   94.73368835,   29.12003326,  122.7570343 ],
#             [  56.74416351,   62.87185669,   83.51163483,  102.64590454],
#             [  56.4704361 ,   67.04311371,   88.26943207,  107.08548737],
#             [  61.38975525,   99.27015686,  116.5189209 ,  127.        ],
#             [  74.17579651,    0.        ,  111.2371521 ,   29.42921066],
#             [  89.39240265,   47.07178497,  126.46971893,   87.31560516],
#             [  69.44123077,   47.38218307,  108.40250397,   79.6802063 ],
#             [   0.        ,   57.49836731,   29.66657829,   95.89842224],
#             [  78.95790863,   37.56030273,  115.78124237,   78.61038971],
#             [   1.05501747,   49.41056061,   23.29784775,   78.91101837],
#             [  85.10821533,   96.18637848,  113.51568604,  127.        ],
#             [   0.        ,    4.97987747,   42.77118683,   39.50862122],
#             [  20.71508408,   86.12203979,   66.83483887,  127.        ],
#             [  92.37216949,    5.15529823,  120.51592255,   36.1371994 ],
#             [  18.54267502,    7.85336876,   47.64195633,   40.28590393],
#             [  70.94502258,   10.51726341,   96.90571594,   49.78765106],
#             [  78.40616608,   34.65525818,  110.38196564,   65.63249969],
#             [  62.15895844,   59.15465546,  105.94535065,   89.95876312],
#             [   1.27451801,   69.83500671,   25.79981232,   97.2482605 ],
#             [  62.73934174,   83.32158661,  101.73313141,  120.8647995 ],
#             [  45.75923157,   59.99327469,   71.63579559,   98.12197876],
#             [  56.19100189,   14.82108879,   84.26691437,   44.36116791],
#             [  65.84653473,   42.47505951,   97.59632111,   82.20253754],
#             [  69.37020874,   94.50706482,  108.35041809,  127.        ],
#             [  37.10490417,    9.61324596,   64.72504425,   38.63171387],
#             [  85.3844986 ,   66.10962677,  110.31502533,  107.09311676],
#             [  37.36283112,   60.59078217,   61.06542206,   91.03170013],
#             [  67.89260864,   71.75512695,  106.5725708 ,  102.57484436],
#             [  77.99923706,   16.48104858,  107.95568848,   48.56900024],
#             [  89.20878601,   71.41056824,  125.7568512 ,  107.29753113],
#             [   5.91212463,   32.58755112,   41.92187881,   62.24328232],
#             [  52.27661133,   39.26787949,   81.46669006,   69.80540466],
#             [  47.65753937,   40.49248505,   76.20034027,   76.36449432],
#             [  57.34262848,    7.1027317 ,   82.6523056 ,   36.4445343 ],
#             [  18.88934326,   92.23389435,   47.76045227,  124.64731598],
#             [   9.30751991,   49.58087158,   42.02339172,   77.00914764],
#             [  45.11285782,   61.83740234,   75.83686829,   87.559021  ],
#             [  15.24866962,   45.1537323 ,   40.4258461 ,   72.44976044],
#             [  26.69694901,   13.21245193,   60.47519302,   42.36695862],
#             [   3.4413681 ,   88.63192749,   40.75950241,  116.03289795],
#             [  33.86211777,   72.85886383,   64.36898804,  111.14054108],
#             [  27.03687096,   89.1621933 ,   60.37636566,  116.18755341],
#             [  32.48144913,   47.85022736,   59.34322739,   74.05560303],
#             [  15.24499512,   57.00760651,   38.60559464,   84.32082367],
#             [   9.1018734 ,   68.70444489,   41.70313263,   95.08370209],
#             [  29.1010685 ,   40.56064987,   54.72600555,   74.27661133],
#             [  63.39616394,   20.40607834,   91.86817932,   48.19306564],
#             [  59.84752655,   49.76169586,   92.02407074,   74.77848816],
#             [  22.08538437,   24.85385132,   47.61610031,   57.60162354],
#             [  46.91257477,   17.56220245,   76.49073029,   44.3457756 ],
#             [  31.83808899,   58.19957733,   59.74316406,   81.0170517 ],
#             [  32.10147095,   74.45246124,   59.8211441 ,   97.25855255],
#             [  56.94638062,   24.92946815,   84.93023682,   58.81396484],
#             [  17.57852745,   71.32565308,   40.61666107,  100.14833069],
#             [  44.46640396,   25.70672989,   69.00811768,   59.31702042],
#             [  31.93849182,   42.83921432,   60.13134766,   66.11750793],
#             [  47.41349792,   45.91717911,   75.39443207,   69.51273346]])
#         all_rois = keras.backend.variable(all_rois, 'float32')
#         gt_boxes = numpy.array([[ 105.,    7.,  127.,   44.],
#                                 [  51.,   78.,   92.,   98.]])
#         gt_boxes = keras.backend.variable(gt_boxes, 'float32')
#         gt_labels = numpy.array([[0, 1], [0, 1]])
#         gt_labels = keras.backend.variable(gt_labels)
#
#         rois, labels, bbox_targets = proposal_target.sample_rois(all_rois, gt_boxes, gt_labels)
#
#         expected_rois = numpy.array([
#             [  50.71208954,   70.44628143,   90.61702728,   99.66291046],
#             [  55.45672607,   67.94913483,   86.19535828,   98.13130951],
#             [ 107.53626251,    1.19126511,  127.        ,   40.5984726 ],
#             [ 101.94552612,    0.        ,  125.88674927,   37.46565247],
#             [  94.43806458,    3.28402901,  127.        ,   44.11544037],
#             [ 108.26307678,   18.04890442,  127.        ,   51.71542358],
#             [ 103.44710541,   14.21045494,  127.        ,   40.28822327],
#             [  52.54270172,   71.56542969,   84.0104599 ,  106.01870728],
#             [  50.50813293,   79.33403778,   87.0002594 ,  117.19319916],
#             [  98.8294754 ,   21.01197243,  127.        ,   59.66217804]])
#         expected_labels = numpy.array([
#             [ 0.,  1.],
#             [ 0.,  1.],
#             [ 0.,  1.],
#             [ 0.,  1.],
#             [ 0.,  1.],
#             [ 0.,  1.],
#             [ 0.,  1.],
#             [ 0.,  1.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.],
#             [ 1.,  0.]])
#         expected_bbox_targets = numpy.array([
#             [ 0.        ,  0.        ,  0.        ,  0.        ,  0.02042398,
#               0.09747626,  0.02641888, -0.36386994],
#             [ 0.        ,  0.        ,  0.        ,  0.        ,  0.02123462,
#               0.15905811,  0.28013501, -0.3953242 ],
#             [ 0.        ,  0.        ,  0.        ,  0.        , -0.06196949,
#              0.11396806,  0.11683983, -0.06142201],
#             [ 0.        ,  0.        ,  0.        ,  0.        ,  0.08355093,
#              0.1759277 , -0.08102778, -0.01217951],
#             [ 0.        ,  0.        ,  0.        ,  0.        ,  0.15734991,
#              0.04303618, -0.37789834, -0.09606142],
#             [ 0.        ,  0.        ,  0.        ,  0.        , -0.08266427,
#             -0.27064049,  0.15300302,  0.0918118 ],
#             [ 0.        ,  0.        ,  0.        ,  0.        ,  0.0316233 ,
#             -0.06460429, -0.06533553,  0.33887312],
#             [ 0.        ,  0.        ,  0.        ,  0.        ,  0.09928062,
#             -0.02234119,  0.25742209, -0.52369332],
#             [ 0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
#              0.        ,  0.        ,  0.        ],
#             [ 0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
#              0.        ,  0.        ,  0.        ]])
#         numpy.testing.assert_array_almost_equal(keras.backend.eval(rois)[:10, :], expected_rois)
#         numpy.testing.assert_array_almost_equal(keras.backend.eval(labels), expected_labels)
#         numpy.testing.assert_array_almost_equal(keras.backend.eval(bbox_targets)[:10, :], expected_bbox_targets)
#
# def test_get_bbox_regression_labels():
#     bbox_target_data = numpy.array([
#         [0, 0, 0, 0],
#         [.1, .2, -.1, -.3],
#         [1, 2, 3, 4],
#         [.1, .2, -.1, -.3],
#         [1, 2, 3, 4]
#     ])
#     bbox_target_data = keras.backend.variable(bbox_target_data)
#     num_classes = 3
#     labels = numpy.array([[0, 1, 0], [1, 0, 0], [1, 0, 0], [0, 0, 1], [0, 1, 0]])
#     labels = numpy.argmax(labels, axis=1)
#     labels = keras.backend.variable(labels)
#     bbox_targets = proposal_target.get_bbox_regression_labels(bbox_target_data, labels, num_classes)
#     bbox_targets = keras.backend.eval(bbox_targets)
#
#     assert bbox_targets.shape == (5, 4 * num_classes)
#     expected = numpy.array([
#         [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
#         [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
#         [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
#         [0, 0, 0, 0, 0, 0, 0, 0, .1, .2, -.1, -.3],
#         [0, 0, 0, 0, 1, 2, 3, 4, 0, 0, 0, 0]
#     ])
#     numpy.testing.assert_array_almost_equal(bbox_targets, expected)
#
